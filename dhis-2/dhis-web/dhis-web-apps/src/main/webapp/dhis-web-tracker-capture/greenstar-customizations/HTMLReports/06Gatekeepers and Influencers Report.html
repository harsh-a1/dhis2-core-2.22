
<script type="text/javascript">

	var periods = dhis2.report.periods;
	var period = periods[0];
	var orgUnit = dhis2.report.organisationUnit;		
	orgUnit.parent = dhis2.report.organisationUnitHierarchy[1];
	var orgUnitChildren = dhis2.report.organisationUnitChildren;
	var orgUnitUIDs = "";
	var res = "";
	var orgUnitGroup =[],orgUnitChildrenFromGroup=[],  userGroupAccesses =[],  orgGroups =[],orgUnitGroupName=[] ,  userGroupId =[];
	res.length=0;
	var prgUID = "bmV01XjtusU";	
	var tableDX = [ 
					
					{ dxName: "Gatekeepers/Influencers covered", dxId: "sO1j4Q1cHsE", cocId: "" },			
				];
				
	
	var deUIDs = "";
	
	var url = window.location.href;
	var params = url.split('=');
	var gotPeriod=params[2];
	var showingTable="datavalue1";

	jQuery( document ).ready( function() {	

	$.getJSON("../api/me.json?fields=id", function(data2){ 
var me = data2.id;

	 $.getJSON("../api/users/"+me+".json", function (data) { // current user
			
			if(data.userGroups.length>0){
          userGroupId.push(data.userGroups[0].id);} // get id of userGroupId assigned to current user
		 
		  $.getJSON("../api/organisationUnitGroups.json", function(data1){
		  
		  for(var i=0;i<data1.organisationUnitGroups.length;i++){
			//orgGroups.push(data1.organisationUnitGroups[i].id);
		   
		   $.getJSON("../api/organisationUnitGroups/"+data1.organisationUnitGroups[i].id+".json", function(data3){
		   
		   if(data3.userGroupAccesses.length>0 && userGroupId.length>0){
	//	 if(data3.userGroupAccesses.length>0){
		 
		 for(var j=0; j<data3.userGroupAccesses.length;j++){
		    userGroupAccesses.push(data3.userGroupAccesses[j].userGroupUid);
		   if (userGroupId == data3.userGroupAccesses[j].userGroupUid){
		    orgUnitGroup.push( data3.id);
			orgUnitGroupName.push(data3.displayName);
		   }
		   }
		   }
		  // else{
		 //  orgUnitGroupName.push( "No orgUnit group shared to this user");
		 //  }
		 console.log("orgUnitGroup---"+orgUnitGroup+"orgUnitGroupName--"+orgUnitGroupName);
		  $.each(orgUnitGroupName, function (index, item) { // append orgunit name in dropdown menu
                    $('#dropdown').append(
                           // $('<option></option>').val(item.id).html(item).text(item.name)
							 $('<option></option>').val(item).html(item).text(item)
                    );
                });
		 
		 
		   });
				
}
 });
 });
  });
		//validateReport();
		$(".hideInPrint").hide();
		orgUnitChildren.sort( function( a, b ){
				if ( a.name < b.name )
					return -1;
				if ( a.name > b.name )
					return 1;
				return 0;
			});
				
		$.each( tableDX, function () {
			deUIDs += this.dxId + ";";						
		});

		$.each( orgUnitChildren, function () {
			orgUnitUIDs += this.id + ";";		
		});
		 $( "#datepicker" ).datepicker({  dateFormat: "mm/dd/yy"});
        $( "#datepicker1" ).datepicker({  dateFormat: "mm/dd/yy"});
		//loadData();
		
		$("#btnExport").click(function(e) {
			window.open('data:application/vnd.ms-excel,'+ encodeURIComponent($('#printing').html()));
			e.preventDefault();
		});
		
	});
	function hideLoad()
	{
		document.getElementById("cover").style.display="none";
		document.getElementById("loads").style.display="none";
		document.getElementById("loading").style.display="none";
		document.getElementsByTagName("body")[0].style.overflow="scroll";
	}
	
	function validateReport()
	{
		$.get("../api/organisationUnitGroups/hdvIWjIWixd?filter=organisationUnits.id:eq:"+orgUnit.id,function(json){
	
			if( !json.name )
			{
				alert("Selected Facility is not in Intervention OU Group");
				window.history.back();	
			}
			else
			{
				loadData();
			}
		});
	}
		
	
	function getPeriod( pr )
	{
		var year = pr.substring(0,4);
		var month = pr.substring(4,6);
		var strMonth="";
		
		if(month=="01" || month=="1") 		strMonth="January";
		else if(month=="02" || month=="2")	strMonth="February";
		else if(month=="03" || month=="3")	strMonth="March";
		else if(month=="04" || month=="4")	strMonth="April";
		else if(month=="05" || month=="5")	strMonth="May";
		else if(month=="06" || month=="6")	strMonth="June";
		else if(month=="07" || month=="7")	strMonth="July";
		else if(month=="08" || month=="8")	strMonth="August";
		else if(month=="09" || month=="9")	strMonth="September";
		else if(month=="10")				strMonth="October";
		else if(month=="11") 				strMonth="November";
		else if(month=="12")				strMonth="December";
		
		return strMonth + " " +year;
	}

	var periodArray = [];
//	var cYear = parseInt( gotPeriod.substring(0,4) );
//	var cMonth = parseInt( gotPeriod.substring(4,6) );
//	var periodsStr = gotPeriod.substring(0,4)+""+gotPeriod.substring(4,6);
		
	var jsonData1;
	var jsonData2;
	var jsonData3;
		
	function loadData()
	{	
	var orgUid;
          /*  $("#dropdown").change(function () {
                selectedText = $(this).find("option:selected").text();
                orgUid = $(this).find("option:selected").val();
            });*/
			  var orgUnitList = document.getElementById('dropdown');
            var tempOrgUnitUid = orgUnitList.options[orgUnitList.selectedIndex].value;
			console.log("orgUid---"+tempOrgUnitUid);
	
	if (tempOrgUnitUid == "base" || tempOrgUnitUid == undefined) {
                alert("Select OrganisationUnit");
                return;
            }
	var start = document.getElementById('datepicker').value;
	
			startDate = start.split("/").reverse().join("-");

			var end = document.getElementById('datepicker1').value;
			var end = document.getElementById('datepicker1').value;
			if (start == undefined || end == undefined || start =="" || end =="") {
                alert("Select Start date and End date");
                return;
            }
			endDate = end.split("/").reverse().join("-");
			 document.getElementById('period1').innerHTML=start;
        document.getElementById('period2').innerHTML=end;
					
			var sstart= new Date(start);
	var edate= new Date(end);

    		
    		var timeDiff = Math.abs(sstart.getTime() - edate.getTime());
var diffDays = Math.ceil(timeDiff / (1000 * 3600 * 24));
			
			
			
			
var inc =0;
       

			var edate= new Date(end);
			
			while(inc<=diffDays)
			{
		  var month=sstart.getMonth()+1;
		  if(month<10)
		  {month="0"+month;}
		  
		
		 var year= sstart.getFullYear();
		 var date1=sstart.getDate();
		   if(date1<10)
		  {date1="0"+date1;}
		 date = year+''+month+''+date1+';';
		  
res = res.concat(date);
		
		//console.log("date"+date);
		
			sstart.setDate(sstart.getDate() + 1);
			
inc= inc+1;

			}
res = res.substring(0,res.length - 1);				
		document.getElementById('selectedOUName').innerHTML= orgUnitGroupName;
		//document.getElementById('period').innerHTML=getPeriod(gotPeriod);
		
	var orgUnitUIDsFromGroup ="-1";
		$.get("../api/organisationUnitGroups/"+orgUnitGroup+".json?fields=id,displayName,organisationUnits[id,name]", function(json1)
	{
		for(var i=0; i<json1.organisationUnits.length;i++ ){
		orgUnitUIDsFromGroup += ";"+json1.organisationUnits[i].id;

	
	orgUnitChildrenFromGroup.push({id:json1.organisationUnits[i].id ,name:json1.organisationUnits[i].name});
		
		//orgUnitChildrenFromGroup[json1.organisationUnits[i].id] = json1.organisationUnits[i].name;
		
		}
			console.log("orgUnitUIDsFromGroup----"+orgUnitUIDsFromGroup);
		var url = "../api/analytics.json?dimension=dx:"+ deUIDs +"&dimension=ou:"+ orgUnitUIDsFromGroup +"&filter=pe:"+ res+"&program="+prgUID;
	//	var url = "../api/analytics.json?dimension=dx:"+ deUIDs +"&dimension=ou:"+ orgUnitUIDs +"&filter=pe:"+ res +"&program="+prgUID;
		console.log( url );
		$.get(url, function(json)
		{
			//console.log( "../api/analytics.json?dimension=dx:"+ deUIDs +"&dimension=ou:"+ orgUnitUIDs +"&dimension=pe:"+ periodsStr );
			//console.log( "************************" );
			
			console.log( "************************URL: " + url );
			
			jsonData1 = json;
			//console.log( jsonData1 );
			
			loadReport( );
		});	
				});	
	}
	
	function loadReport( )
	{
		var htmlReport="";
		//var selYear = gotPeriod.substring(0,4);
		//var selMonth = gotPeriod.substring(4,6);
				
		//console.log( jsonData1 );
		$("#"+showingTable+" > thead").html("");

		htmlReport += "<thead><tr bgcolor='#F2DDDC' align='center' height='44'>";
		htmlReport += "<td>OrgUnit</td>";
		$.each( tableDX, function () {
			htmlReport += "<td>"+ this.dxName +"</td>;";						
		});
		htmlReport +="</tr></thead>";
		
		$("#"+showingTable+" > tbody").html("");
		htmlReport += "<tbody>";
	//	$.each( orgUnitChildren, function ( index1, ou ) {	
$.each( orgUnitChildrenFromGroup, function ( index1, ou ) {				
			htmlReport+="<tr>";						
			htmlReport+="<td align='left'style='padding-left:5px'>"+ou.name+"</td>";
			$.each( tableDX, function ( index2, de ) {
				var temp = getCellValue( jsonData1, de.dxId, ou.id, res );
				htmlReport+="<td align='center'>"+ temp +"</td>";
			});			
			htmlReport+="</tr>";	
		});		
		htmlReport+="</tbody>";		
		
		$("#"+showingTable ).append( htmlReport );
		hideLoad();
	}

	function getCellValue( json, de, ou, res )
	{
		var result=0;
		for (var i=0; i < json.rows.length; i++)
		{
			//console.log( json.rows[i][0] + " : " + json.rows[i][1] + " : " + json.rows[i][2] + " : " + json.rows[i][3] );
			//console.log( de + " : " + ou + " : " + coc );
			//console.log( "********************************************" );
			if( json.rows[i][0] == de  && json.rows[i][1] == ou && json.rows[i][2]!= null )
			{
				result=json.rows[i][2];
			}
		}		
		return parseInt( result );
	}

</script>


<!-- download script ------------------------------------------------------
		--------------------------------------------------------------------------
		-------------------------------------------------------------------------------------- -->
<script type="text/javascript">
	 var tablesToExcel = (function() {
    var uri ='data:application/vnd.ms-excel;base64,', tmplWorkbookXML ='<?xml version="1.0"?><?mso-application progid="Excel.Sheet"?><Workbook xmlns="urn:schemas-microsoft-com:office:spreadsheet" xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet">'+'<DocumentProperties xmlns="urn:schemas-microsoft-com:office:office"><Author>ThaiND</Author><Created>{created}</Created></DocumentProperties>'+'<Styles><Style ss:ID="Default" ss:Name="Normal"><Alignment ss:Horizontal="Center" ss:WrapText="1"/><Borders><Border ss:Position="Bottom" ss:LineStyle="Continuous" ss:Weight="1"/><Border ss:Position="Top" ss:LineStyle="Continuous" ss:Weight="1"/><Border ss:Position="Left" ss:LineStyle="Continuous" ss:Weight="1"/><Border ss:Position="Right" ss:LineStyle="Continuous" ss:Weight="1"/></Borders><Font/><Interior /><NumberFormat /><Protection /></Style><Style ss:ID="s21"><Alignment ss:WrapText="1" ss:Horizontal="Center" ss:Vertical="Center"/><Font ss:Size="10" ss:Bold="1" /><Interior ss:Color="#999999" ss:Pattern="Solid" /><Borders><Border ss:Position="Bottom" ss:LineStyle="Continuous" ss:Weight="1"/><Border ss:Position="Top" ss:LineStyle="Continuous" ss:Weight="1"/><Border ss:Position="Left" ss:LineStyle="Continuous" ss:Weight="1"/><Border ss:Position="Right" ss:LineStyle="Continuous" ss:Weight="1"/></Borders></Style> <Style ss:ID="s22"><Alignment ss:WrapText="1" ss:Horizontal="Center" ss:Vertical="Center"/><Font ss:Size="10" ss:Bold="1" /><Interior ss:Color="#999999" ss:Pattern="Solid" /><Borders><Border ss:Position="Bottom" ss:LineStyle="Continuous" ss:Weight="1"/><Border ss:Position="Top" ss:LineStyle="Continuous" ss:Weight="1"/><Border ss:Position="Left" ss:LineStyle="Continuous" ss:Weight="1"/><Border ss:Position="Right" ss:LineStyle="Continuous" ss:Weight="1"/></Borders></Style><Style ss:ID="s64"> <Alignment ss:WrapText="1" ss:Horizontal="Center" ss:Vertical="Center" ss:Indent="0" ss:Rotate="90"/><Font ss:Size="10" ss:Bold="1" /><Interior ss:Color="#999999" ss:Pattern="Solid" /> </Style> </Styles>'+'{worksheets}</Workbook>', tmplWorksheetXML ='<Worksheet ss:Name="{nameWS}"><Table><Column ss:AutoFitWidth="0" ss:Width="100"/><Column ss:AutoFitWidth="0" ss:Width="150"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/>{rows}</Table></Worksheet>', tmplCellXML ='<Cell ss:StyleID="{sid}" ss:MergeAcross="{mrg}"><Data ss:Type="{dtype}">{data}</Data></Cell>', base64 = function(s) { return window.btoa(unescape(encodeURIComponent(s))) }
    , format = function(s, c) { return s.replace(/{(\w+)}/g, function(m, p) { return c[p]; }) }
	
    return function(tables, wsnames, wbname) {
		var ctx = "";
		var workbookXML = "";
		var worksheetsXML = "";
		var rowsXML = "";
		
		for (var i = 0; i < tables.length; i++) 
		{
		
			if (!tables[i].nodeType) 
			tables[i] = document.getElementById(tables[i]);
		
			for (var j = 0; j < tables[i].rows.length; j++) 
			{
				rowsXML +='<Row>'for (var k = 0; k < tables[i].rows[j].cells.length; k++) 
				{
					
					var cols=tables[i].rows[j].cells[k].getAttribute("colspan");
					var rws=tables[i].rows[j].cells[k].getAttribute("rowspan");
					var styl=tables[i].rows[j].cells[k].getAttribute("bgcolor");
					var styl2=tables[i].rows[j].getAttribute("bgcolor");
					var cls=tables[i].rows[j].cells[k].getAttribute("class");
					
						var dataType ='String';
						var dataValue = tables[i].rows[j].cells[k].innerHTML;
						var typeD="";
						var parsed=parseInt(dataValue);
						
						if (parsed==dataValue)
						{
							typeD="Number";
						}
						else
						{
							typeD="String";
						}
					
					
					
					if(styl2)
					{
						if(cols)
						{
							if(cls=="aso")
							{
								ctx = {data: dataValue, mrg: cols-1, sid:"s64",dtype:typeD};
								rowsXML += format(tmplCellXML, ctx);
							}
							else
							{
								ctx = {data: dataValue, mrg: cols-1, sid:"s22",dtype:typeD};
								rowsXML += format(tmplCellXML, ctx);
							}
						}

						else
						{
							if(cls=="aso")
							{
								ctx = {data: dataValue, mrg: 0, sid:"s64",dtype:typeD};
								rowsXML += format(tmplCellXML, ctx);
							}
							else
							{
								ctx = {data: dataValue, mrg: 0, sid: "s22",dtype:typeD};
								rowsXML += format(tmplCellXML, ctx);
							}
						}
					}
				
					else if(styl)
					{
						if(cols)
						{
							ctx = {data: dataValue, mrg: cols-1, sid:"s21",dtype:typeD};
							rowsXML += format(tmplCellXML, ctx);
						}

						else
						{
							ctx = {data: dataValue, mrg: 0, sid: "s21",dtype:typeD};
							rowsXML += format(tmplCellXML, ctx);
						}
					}
					
					else
					{
						if(cols)
						{
							ctx = {data: dataValue, mrg: cols-1, sid:"Default",dtype:typeD};
							rowsXML += format(tmplCellXML, ctx);
						}

						else
						{
							ctx = {data: dataValue, mrg: 0, sid: "Default",dtype:typeD};
							rowsXML += format(tmplCellXML, ctx);
						}
					
					}
					
				}
				  rowsXML +='</Row>'}
			ctx = {rows: rowsXML, nameWS: wsnames[i] ||'Sheet'+ i};
			worksheetsXML += format(tmplWorksheetXML, ctx);
			rowsXML = "";
      }

		ctx = {created: (new Date()).getTime(), worksheets: worksheetsXML};
		workbookXML = format(tmplWorkbookXML, ctx);

		//console.log(workbookXML);

		var link = document.createElement("A");
		link.href = uri + base64(workbookXML);
		link.download = wbname ||'Workbook.xls';
		link.target ='_blank';
		document.body.appendChild(link);
		link.click();
		document.body.removeChild(link);
    }
  })();
</script>
<script type="text/javascript">
	function printContent(el){
	var restorepage = document.body.innerHTML;
	var printcontent = document.getElementById(el).innerHTML;
	document.body.innerHTML = printcontent;
	window.print();
	document.body.innerHTML = restorepage;
}
</script>
<p><span style="font-size:12px;">
<style>
	
	td
	{
		padding: 5px 10px;
		font:Arial, Helvetica, sans-serif;
	}
	
	bd
	{
		border-style: solid;
		border-color:#000000;
	}	
	
	#cover{ position:fixed; top:0; left:0; background:rgba(0,0,0,0.7); z-index:5; width:100%; height:100%;}
			#loads { height:100px; width:500px; position:fixed; z-index:10;  margin:0 auto;   top: 50%; left: 50%; margin-top:-50px; margin-left:-250px; background:#999; border:5px solid #cccccc; text-align=center; border-radius:5px; }
			.loading { width:400px; font-size:20px; font-family:verdana; font-weight:bolder; position:fixed;  top: 50%; left: 50%; margin:0 auto; margin-top:-8px; margin-left:-200px;}
			.vtext{
			/*width:1px;
			height: 50px;
			-ms-transform: rotate(90deg);
			-webkit-transform: rotate(90deg); 
			transform: rotate(90deg); 
			border-style: hidden;*/
	}
		select {
        height:30px;
        line-height:10px;
        background:#f4f4f4;
    } 
</style>


</span></p>
<table>
	<tr>
		<td>
			<input type="button" id="btnBack" value=" Go to Dashboard" onclick="location.href='../dhis-web-dashboard-integration/index.action'"/>
            <input type="button"  onclick="printContent('printing');" value="Print"/>
			<!--<input type="button" id="btnExport" value=" Download Excel " />-->
				
				
		</td>	
	</tr>
</table>
</br></br>

<table>
    <tr>
        <td>Start Date:</td>
        <td>End Date:</td>
    </tr>
    <tr>
        <td><input type="text" id="datepicker"></td>
        <td><input type="text" id="datepicker1"></td>
         <select id="dropdown" value="base" style=" margin-left:1%; width:10%; ">
                <option selected value="base" class="dropbtn">Select OrgUnit Group</option>
            </select>
        <td>	<input type="button"  onClick="loadData()"  value="go" style="width:50px;margin-left:50%; margin-top:5px;"/>	</td>
    </tr>
</table>
</br></br>

<div id="printing">
	<table >
		<tr>
			<td>
				<table border="1" cellspacing="6" cellpadding="4"   width="100%" style="border-collapse:collapse; border:2px; font-weight:bolder" >
					<thead>
						<tr align="center"  height="27">
							<td  colspan="12" width="2082" height="27" class="col" bgcolor="#32849C" ><font color="white"><b>Gatekeepers and Influencers Coverage Report</b></font></td>
						</tr>
						<tr bgcolor="#F2DDDC" align="center" height="20">
							<td colspan="1" height="20" align="right"><b>Parent OU:</b></td>
							<td colspan="2" id="selectedOUName">&nbsp;</td>				
							<td colspan="5">&nbsp;</td>				
							 <td colspan="1" align="right"><b>Start Date: </b></td>
                          <td colspan="1" id="period1">&nbsp;</td>
                          <td colspan="1" align="right"><b>End Date: </b></td>
                          <td colspan="1" id="period2">&nbsp;</td>	
						</tr>
					</thead>				
				</table>
			</td>
		</tr>
		<tr>
			<td>
				<table id="datavalue1" border="1" cellspacing="6" cellpadding="4" width="100%" style="border-collapse:collapse; border:2px; font-weight:bolder" >								
				</table>
			</td>
		</tr>		
	</table>		
</div>